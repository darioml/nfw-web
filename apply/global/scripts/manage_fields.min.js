$(function(){var c=$(".scroll-pane");var b=$(".scroll-content");fields_ns.init_sliders({scroll_panes:c,scroll_content:b});var d=fields_ns.scrollbars.find(".ui-slider-handle").mousedown(function(){fields_ns.scrollbars.width(d.width())}).mouseup(function(){fields_ns.scrollbars.width("100%")}).append("<span class='ui-icon ui-icon-grip-dotted-vertical'></span>").wrap("<div class='ui-handle-helper-parent'></div>").parent();c.css("overflow","hidden");function a(){var f=b.width()-c.width();var h=f/b.width();var e=c.width()-(h*c.width());fields_ns.scrollbars.find(".ui-slider-handle").css({width:e,"margin-left":-e/2});d.width("").width(fields_ns.scrollbars.width()-e)}setTimeout(a,10);$("#display_form").bind("submit",function(f){var h=[];h.push("function,fields_ns.check_fields");fields_ns.__disable_focusin=true;if(!rsv.validate(this,h)){f.preventDefault();fields_ns.__disable_focusin=false}});$(".rows").bind("focusin",function(k){if(fields_ns.__disable_focusin){return}var h=k.target;if($(h).hasClass("display_text")){fields_ns.__onfocus_display_text_value=$(h).val()}var j=$(h).closest(".scrollable");if(j.hasClass("col3")){var l=j.attr("scrollLeft");var i=parseInt($(h).closest(".scroll-content").css("marginLeft"));if(l!=0){var f=(i<=0&&i>-238)?50:100;fields_ns.change_scroll_area(f)}}});$(".rows").bind("focusout",function(f){if(!$(f.target).hasClass("display_text")){return}if($(f.target).val()!=fields_ns.__onfocus_display_text_value){fields_ns.update_fields_dropdown()}});$(".rows").live("click",function(f){if($(f.target).hasClass("edit")){fields_ns.edit_field($(f.target).closest(".row_group"))}});$("#edit_field_template .prev_field").bind("click",function(f){fields_ns.edit_prev_field()});$("#edit_field_template .next_field").bind("click",function(f){fields_ns.edit_next_field()});$(".use_default").live("click",function(){fields_ns.click_use_default(this)});$("#edit_field__field_type").live("change keyup",function(){ft.update_field_size_dropdown(this,$("#edit_field__field_size_div"),{id:"edit_field__field_size",name:"edit_field__field_size",selected:$("#edit_field__field_size").val()});var h=$(this).val();var e=page_ns.field_settings["field_type_"+h];var i=$("#edit_field__field_type option[value="+h+"]").text();if(e==undefined){$("#edit_field_template .inner_tab2").html(i+" "+g.messages.word_settings+" (0)");$("#edit_field__field_settings").html('<div class="notify"><div style="padding:6px">'+g.messages.notify_no_field_settings+"</div></div>")}else{$("#edit_field_template .inner_tab2").html(i+" "+g.messages.word_settings+" ("+e.length+")");var f=fields_ns.generate_field_type_markup(fields_ns.__current_field_id,h,e);$("#edit_field__field_settings").html(f)}$("#edit_field__field_settings_loading").hide();$(".use_default").each(function(){$(this).attr("disabled","")});var f=fields_ns.generate_field_type_validation_table(h);fields_ns.update_validation_tab_label(h);$("#validation_table").html(f)});$("#edit_field__field_type").live("blur",function(){fields_ns.__last_field_type_id=fields_ns.__current_field_type_id;fields_ns.__current_field_type_id=this.value;fields_ns.__check_shared_characteristics_cond1=true;fields_ns.check_shared_characteristics();delete fields_ns.memory["field_"+fields_ns.__current_field_id].tab2});$(".inner_tab_content").bind("change",function(f){if(typeof fields_ns.memory["field_"+fields_ns.__current_field_id]=="undefined"){fields_ns.memory["field_"+fields_ns.__current_field_id]={tab1:null,tab2:null,tab3:null};fields_ns.memory.changed_field_ids.push(fields_ns.__current_field_id)}fields_ns.memory["field_"+fields_ns.__current_field_id].tab1=$("#edit_field_form_tab1").serializeArray();fields_ns.memory["field_"+fields_ns.__current_field_id].tab2=$("#edit_field_form_tab2").serializeArray();fields_ns.memory["field_"+fields_ns.__current_field_id].tab3=$("#edit_field_form_tab3").serializeArray()});$(".field_types").live("change keyup",function(j){var h=$(this).attr("name").match(/field_(.+)_type_id/);var k=h[1];var f=$(this).closest(".scroll-content").find(".field_sizes_div");var i=f.find("[name=field_"+k+"_size]").val();ft.update_field_size_dropdown(this,f,{name:"field_"+k+"_size",html_class:"field_sizes",selected:i})});$(".option_list_or_form_field").live("change",function(){if($(this).find(":selected").closest("optgroup").is("#edit_field__option_lists")){$("#edit_field__option_list_options").show();$("#edit_field__form_options").hide()}else{if($(this).find(":selected").closest("optgroup").is("#edit_field__forms")){var e=this.value.replace(/^ft/,"");$("#edit_field__option_list_options").hide();$("#edit_field__form_options").show();if(fields_ns.form_fields["form_"+e]==undefined){fields_ns.load_form_fields({form_id:e})}else{fields_ns.generate_form_fields_section({form_id:e})}}}});$(".check_areas").live("click",function(h){if(!$(h.target).hasClass("check_area")){return}var f=$(h.target).find("input")[0];fields_ns.click_use_default(f)});$.ajax({url:g.root_url+"/global/code/actions.php",type:"POST",dataType:"json",data:{action:"get_option_lists"},success:fields_ns.get_option_lists_response,error:ft.error_handler});$.ajax({url:g.root_url+"/global/code/actions.php",type:"POST",dataType:"json",data:{action:"get_form_list"},success:fields_ns.get_form_list_response,error:ft.error_handler});$("#validation_table").bind("change",function(i){if(!$(i.target).hasClass("v_checked")){return}var f=$(i.target).closest("tr").find(".validation_error_message");if(i.target.checked){var h=$(i.target).attr("id").replace(/edit_field__v_/,"");f.removeClass("light_grey").attr("disabled","");if(f.val()==""){f.val(fields_ns._get_default_error_message(fields_ns.__current_field_type_id,h))}}else{f.addClass("light_grey").attr("disabled","disabled")}})});$(window).resize(function(){fields_ns.reinit_sliders()});var fields_ns={num_new_rows:0,add_field_dialog:$("<div></div>"),smart_fill_dialog:$("<div></div>"),confirm_redirect_dialog:$('<div id="confirm_before_redirect_dialog"></div>'),edit_field_dialog_opened:false,cached_field_settings_markup:[],cached_loaded_extended_field:[],memory:{changed_field_ids:[]},onload_field_setting_values:[],option_lists:null,forms:null,form_fields:{},__current_field_id:null,__current_field_type_id:null,__last_field_type_id:null,__disable_focusin:false,__check_shared_characteristics_cond1:false,__check_shared_characteristics_cond2:false};fields_ns.reinit_sliders=function(){fields_ns.init_sliders({scroll_panes:$(".scroll-pane"),scroll_content:$(".scroll-content")})};fields_ns.get_option_lists_response=function(a){if(!ft.check_ajax_response_permissions(a)){return}fields_ns.option_lists=a};fields_ns.get_form_list_response=function(a){fields_ns.forms=a};fields_ns.init_sliders=function(d){var c=fields_ns._get_max_rows_on_page();var b=d.scroll_content.slice(0,c);var a=d.scroll_content.slice(-c);fields_ns.scrollbars=$(".scroll-bar-top, .scroll-bar-bottom").slider({slide:function(h,i){var j=null;var f=null;if($(this).hasClass("scroll-bar-top")){j=b;f=".scroll-bar-bottom"}else{j=a;f=".scroll-bar-top"}var e=j.width();if(e>d.scroll_panes.width()){j.css("margin-left",Math.round(i.value/100*(d.scroll_panes.width()-e))+"px")}else{j.css("margin-left",0)}$(f+" .ui-slider-handle").css("left",Math.round(i.value)+"%")},change:function(h,i){var e=null;var j=null;var f=fields_ns._get_max_rows_on_page();if($(this).hasClass("scroll-bar-top")){e=$(".scroll-content:first").css("marginLeft");j=$(".scroll-content").slice(f)}else{e=$(".scroll-content:last").css("marginLeft");j=$(".scroll-content").slice(0,$(".scroll-content").length-f)}j.each(function(){$(this).css("marginLeft",e)})}})};fields_ns.add_fields=function(m){var c=$.trim($("#add_num_fields").val());if(c.match(/\D/)||c==0||c==""){ft.create_dialog({dialog:fields_ns.add_field_dialog,popup_type:"error",title:g.messages.word_error,content:g.messages.validation_num_rows_to_add,buttons:[{text:g.messages.word_okay,click:function(){$(this).dialog("close");$("#add_num_fields").focus().select()}}]});$("#add_num_fields").focus().select();return false}var q=$("#group_new_fields").attr("checked");var a=$("#new_row_template").html();var n=document.createDocumentFragment();var l="";for(var j=0;j<c;j++){fields_ns.num_new_rows++;var p="NEW"+fields_ns.num_new_rows;var k=a.replace(/%%ROW%%/g,p);if(q){l+=k}else{var b=sortable_ns.get_sortable_row_markup({row_group:k});n.appendChild(b[0])}}if(q){var f=sortable_ns.get_sortable_row_markup({row_group:l});n=f[0]}var h=$("#new_field_position").val();if(h=="start"){var s=$("#rows")[0];var o=null;for(var j=0;j<s.childNodes.length;j++){if(s.childNodes[j].nodeType==Node.ELEMENT_NODE){o=s.childNodes[j];break}}if(o==null){document.getElementById("rows").appendChild(n)}else{s.insertBefore(n,o)}}else{if(h=="end"){document.getElementById("rows").appendChild(n)}else{var r=$(".row_group").has("input.sr_order[value="+h+"]");var d=r.next().length!=0;if(d){sortable_ns._disconnect_row(r)}$(r).closest(".sortable_row").after(n)}}sortable_ns.reorder_rows($("#rows"),true);fields_ns.update_fields_dropdown();fields_ns.init_sliders({scroll_panes:$(".scroll-pane"),scroll_content:$(".scroll-content")});return false};fields_ns._get_max_rows_on_page=function(){var a=23;return parseInt($(window).height()/23)};fields_ns.update_fields_dropdown=function(){var b=$("#new_field_position").val();var a="";$(".sortable .display_text").each(function(){var d=$(this).closest(".row_group").find(".sr_order").val();var e=$(this).val();if(e==""){e="["+g.messages.word_row+" "+$(this).closest(".row_group").find(".col1").text()+"]"}var c=(d==b)?" selected":"";a+='<option value="'+d+'"'+c+">"+e+"</option>\n"});$("#add_fields_list").html(a)};fields_ns.smart_fill=function(){ft.create_dialog({dialog:fields_ns.smart_fill_dialog,popup_type:"warning",min_width:450,title:g.messages.phrase_smart_fill,content:'<div class="desc">'+g.messages.confirm_smart_fill_db_column_fields_desc+"</div>"+g.messages.confirm_smart_fill_db_column_fields,buttons:[{text:g.messages.word_okay,click:function(){var a=[];$(".sortable .db_column").each(function(){var d=$(this).attr("id").match(/col_(NEW)?(\d+)_name/);if(d[1]!=undefined){field_id="NEW"+d[2]}else{field_id=d[2]}var i=$.trim($("#field_"+field_id+"_display_name").val());var c=i.replace(/\s+/g,"_");c=c.replace(/[^a-zA-Z0-9_]/g,"").toLowerCase();var b=$.inArray(c.toUpperCase(),page_ns.reserved_words)!=-1||$.inArray(c,a)!=-1;var h=2;var f=null;while(b){f=c+h;b=$.inArray(f.toUpperCase(),page_ns.reserved_words)!=-1||$.inArray(f,a)!=-1;if(!b){break}h++}if(f!=null){c=f}if(c==""){var e="col_";var h=1;b=true;var f=null;while(b){f=e+h;b=$.inArray(f,a)!=-1;if(!b){break}h++}c=f}$(this).val(c);a.push(c)});$(this).dialog("close")}},{text:g.messages.word_cancel,click:function(){$(this).dialog("close")}}]});return false};fields_ns.check_fields=function(c){var e=[];var d=[];var a=[];var b=[0,0,0];$(".sortable .display_text").each(function(){var o=$(this).closest(".row_group");var p=o.find(".sr_order").val();var k=/^NEW/.test(p);var i=o.find(".display_text");var m=$.trim(i.val());if(m==""){if(k){return}e.push([this,g.messages.validation_no_display_text]);b[0]++}else{$(i).removeClass("rsvErrorField")}var f=o.find(".field_names");if(f.length){var j=$.trim(f.val());if(!j){e.push([$(f)[0],g.messages.validation_no_form_field_name]);b[0]++}else{if(j.match(/[^0-9a-zA-Z_]/)){e.push([$(f)[0],g.messages.validation_invalid_form_field_names]);b[0]++}else{if($.inArray(j,d)!=-1){e.push([$(f)[0],g.messages.validation_duplicate_form_field_name]);b[0]++}else{f.removeClass("rsvErrorField")}}}d.push(j)}var h=o.find(".db_column");if(h.length){var n=$.trim(h.val());var l=fields_ns._is_valid_db_column_name(n,a);if(!l.success){e.push([$(h)[0],l.error]);b[2]++}else{h.removeClass("rsvErrorField")}a.push(n)}});if(b[0]>0){fields_ns.change_scroll_area(0)}else{if(b[1]>0){fields_ns.change_scroll_area(50)}else{if(b[2]>0){fields_ns.change_scroll_area(100)}}}return e};fields_ns._is_valid_db_column_name=function(c,b){b.push("submission_id");b.push("submission_date");b.push("last_submission_date");b.push("ip_address");b.push("is_finalized");var d={success:true,error:""};var a=$.trim(c);if(a==""){d={success:false,error:g.messages.validation_no_column_name}}else{if(a.match(/\W/)){d={success:false,error:g.messages.validation_invalid_column_name}}else{if($.inArray(a.toUpperCase(),page_ns.reserved_words)!=-1){d={success:false,error:g.messages.validation_col_name_is_reserved_word}}else{if($.inArray(a,b)!=-1){d={success:false,error:g.messages.validation_no_two_column_names}}}}}return d};fields_ns.change_scroll_area=function(a,c){var b=0;if(a==50){b=-238}else{if(a==100){b=-477}}$(".scrollable").attr("scrollLeft",0);$(".ui-slider-handle").css("left",a+"%");$(".sortable").find(".scrollable").each(function(){$(this).find(".scroll-content").css("marginLeft",b)})};fields_ns.edit_field=function(j){$("#edit_field_template_message").addClass("hidden");var m=$(j).hasClass("system_field");fields_ns.__current_editing_row_group=j;var k=$(j).find(".sr_order").val();var i=(k.match(/^NEW/)!=null)?true:false;fields_ns.__last_field_type_id=null;fields_ns.__check_shared_characteristics=false;var e=($.inArray(k,fields_ns.memory.changed_field_ids)!=-1)?true:false;var b=null;if(e){if(typeof fields_ns.memory["field_"+k].tab1!="undefined"){b=fields_ns.memory["field_"+k].tab1}}if(i){$("#edit_field_template_new_field").removeClass("hidden");$(".tab_row").hide();ft.change_inner_tab(1,"edit_field")}else{$("#edit_field_template_new_field").addClass("hidden");$(".tab_row").show()}var d="";if(b){d=ft._extract_array_val(b,"edit_field__display_text")}else{d=j.find(".display_text").val()}$("#edit_field__display_text").val(d);var n=null;fields_ns.__current_field_id=k;fields_ns.__current_field_is_system_field=m;var c=null;if(m){$(".edit_field__non_system").hide();$(".edit_field__system").show();n=j.find(".system_field_type_id").val();$("#edit_field__field_type_system").html(j.find(".system_field_type_label").html());$("#edit_field__db_column_div_system").html(j.find(".system_field_db_column").html());$("#edit_field__pass_on").attr("checked",j.find(".pass_on").attr("checked"));c=$("#edit_field__field_type option[value="+n+"]").text()}else{$(".edit_field__non_system").show();$(".edit_field__system").hide();var l=j.find(".field_types");n=l.val();if(b){$("#edit_field__field_name").val(ft._extract_array_val(b,"edit_field__field_name"));$("#edit_field__field_type").val(ft._extract_array_val(b,"edit_field__field_type"));ft.update_field_size_dropdown(l,$("#edit_field__field_size_div"),{selected:ft._extract_array_val(b,"edit_field__field_size"),name:"edit_field__field_size",id:"edit_field__field_size"});var f=ft._extract_array_val(b,"edit_field__pass_on");$("#edit_field__pass_on").attr("checked",((f=="")?"":"checked"));$("#edit_field__data_type").val(ft._extract_array_val(b,"edit_field__data_type"));$("#edit_field__db_column").val(ft._extract_array_val(b,"edit_field__db_column"))}else{$("#edit_field__field_name").val(j.find(".field_names").val());$("#edit_field__field_type").val(n);ft.update_field_size_dropdown(l,$("#edit_field__field_size_div"),{selected:j.find(".field_sizes").val(),name:"edit_field__field_size",id:"edit_field__field_size"});$("#edit_field__pass_on").attr("checked",j.find(".pass_on").attr("checked"));$("#edit_field__data_type").val(j.find(".data_types").val());$("#edit_field__db_column").val(j.find(".db_column").val())}c=$("#edit_field__field_type :selected").text()}fields_ns.__current_field_type_id=n;fields_ns.__last_field_type_id=n;fields_ns.update_validation_tab_label(n);var a=fields_ns.init_field_settings_tab(n,k);if(sortable_ns._has_previous_field(j)){$("#edit_field_template .prev_field").removeClass("disabled")}else{$("#edit_field_template .prev_field").addClass("disabled")}if(sortable_ns._has_next_field(j)){$("#edit_field_template .next_field").removeClass("disabled")}else{$("#edit_field_template .next_field").addClass("disabled")}var h=d+'<span class="edit_field_title_field_type">('+c+")</span>";if(!fields_ns.edit_field_dialog_opened){ft.create_dialog({dialog:$("#edit_field_template"),title:h,min_width:720,open:function(){fields_ns.edit_field_dialog_opened=true},close:function(){fields_ns.edit_field_dialog_opened=false},buttons:[{text:g.messages.phrase_save_changes,click:function(){fields_ns.save_changes()}},{text:g.messages.word_close,click:function(){fields_ns.memory={};fields_ns.memory.changed_field_ids=[];$(this).dialog("close")}}]})}else{$("#edit_field_template").dialog({title:h})}};fields_ns.init_field_settings_tab=function(e,c){var a=page_ns.field_settings["field_type_"+e];var f=$("#edit_field__field_type option[value="+e+"]").text();if(a==undefined){$("#edit_field_template .inner_tab2").html(f+" "+g.messages.word_settings+" (0)");$("#edit_field__field_settings").html('<div class="notify"><div style="padding:6px">'+g.messages.notify_no_field_settings+"</div></div>");$("#edit_field__field_settings_loading").hide();return false}else{$("#edit_field_template .inner_tab2").html(f+" "+g.messages.word_settings+" ("+a.length+")")}var b=fields_ns.generate_field_type_markup(c,e,a);$("#edit_field__field_settings").html(b);if(fields_ns.cached_loaded_extended_field["field_id_"+c]==undefined){fields_ns.cached_loaded_extended_field["field_id_"+c]={loaded:false,settings:[],validation:[]};$("#edit_field__field_settings_loading").show();$("#edit_field__field_settings").hide();ft.dialog_activity_icon($("#edit_field_template"),"show");if(!/^NEW/.test(c)){$.ajax({url:g.root_url+"/global/code/actions.php",type:"POST",dataType:"json",data:{field_id:c,field_type_id:e,action:"get_extended_field_settings"},success:fields_ns.load_field_settings_response,error:ft.error_handler})}}else{if(fields_ns.cached_loaded_extended_field["field_id_"+c].loaded){var d=fields_ns.cached_loaded_extended_field["field_id_"+c];fields_ns.display_field_settings(e,d.settings,d.validation)}}return true};fields_ns.generate_field_type_markup=function(m,p,k){var f="";if(fields_ns.cached_field_settings_markup["field_type_"+p]!==undefined){f=fields_ns.cached_field_settings_markup["field_type_"+p];fields_ns.__check_shared_characteristics_cond2=true;fields_ns.check_shared_characteristics()}else{var h=true;f='<table cellspacing="0" cellpadding="0" width="100%" class="check_areas"><tr><th width="200" class="underline medium_grey">'+g.messages.word_setting+'</th><th width="150" align="center" class="underline medium_grey">'+g.messages.phrase_use_default_value_q+'</th><th class="underline medium_grey">'+g.messages.word_value+"</th></tr>";for(var e=0;e<k.length;e++){var b=k[e];f+="<tr><td>"+b.field_label+'</td><td class="check_area" align="center">';var n=true;if(b.field_type=="option_list_or_form_field"){n=false}if(n){f+='<input type="checkbox" class="use_default" id="edit_field__use_default_value_'+b.setting_id+'" checked />'}else{f+='<span class="light_grey">&#8212;</span>'}f+="</td><td>";switch(b.field_type){case"textbox":f+='<input type="text" name="edit_field__setting_'+b.setting_id+'" id="edit_field__setting_'+b.setting_id+'" value="'+b.default_value+'" disabled style="width: 100%" class="light_grey" />';break;case"textarea":f+='<textarea name="edit_field__setting_'+b.setting_id+'" id="edit_field__setting_'+b.setting_id+'" disabled style="width:100%; height: 80px" class="light_grey">'+b.default_value+"</textarea>";break;case"select":f+='<select name="edit_field__setting_'+b.setting_id+'" id="edit_field__setting_'+b.setting_id+'" class="light_grey" disabled>';var o=b.options;for(var d=0;d<o.length;d++){var a=o[d];var c=(a.value==b.default_value)?" selected":"";f+='<option value="'+a.value+'"'+c+">"+a.text+"</option>"}f+="</select>";break;case"checkboxes":for(var d=0;d<b.options.length;d++){if(d>0){f+=(b.field_orientation=="vertical")?"<br />":"&nbsp;"}var a=b.options[d];var l=(a.value==b.default_value)?"checked":"";f+='<input type="checkbox" name="edit_field__setting_'+b.setting_id+'" id="edit_field__setting_'+b.setting_id+"_"+d+'" name="edit_field__setting_'+b.setting_id+'" class="light_grey" value="'+a.value+'" '+l+' disabled><label for="edit_field__setting_'+b.setting_id+"_"+d+'">'+a.text+"</label>"}break;case"radios":for(var d=0;d<b.options.length;d++){if(d>0){f+=(b.field_orientation=="vertical")?"<br />":"&nbsp;"}var a=b.options[d];var l=(a.value==b.default_value)?"checked":"";f+='<input type="radio" name="edit_field__setting_'+b.setting_id+'" id="edit_field__setting_'+b.setting_id+"_"+d+'" name="edit_field__setting_'+b.setting_id+'" class="light_grey" value="'+a.value+'" '+l+' disabled><label for="edit_field__setting_'+b.setting_id+"_"+d+'">'+a.text+"</label>"}break;case"multi-select":f+='<select name="edit_field__setting_'+b.setting_id+'" id="edit_field__setting_'+b.setting_id+'" class="light_grey" multiple size="5" disabled>';for(var d=0;d<b.options.length;d++){var a=b.options[d];var c=(a.value==b.default_value)?" selected":"";f+='<option value="'+a.value+'"'+c+">"+a.text+"</option>"}f+="</select>";break;case"option_list_or_form_field":f+='<div id="option_list_div_'+b.setting_id+'">';if(fields_ns.option_lists==null||fields_ns.forms==null){h=false;(function(j,i){ft.queue.push([function(){},function(){var q=(fields_ns.option_lists!=null);var s=(fields_ns.forms!=null);if(q&&s){$("#option_list_div_"+j).html(fields_ns._generate_option_list_markup(j,i));fields_ns.__check_shared_characteristics_cond2=true;fields_ns.check_shared_characteristics()}for(var r=0;r<fields_ns.onload_field_setting_values.length;r++){if(fields_ns.onload_field_setting_values[r].setting_id==j){$("#option_list_div_"+j).html(fields_ns._generate_option_list_markup(j,fields_ns.onload_field_setting_values[r].setting_value))}}return q}]);ft.process_queue()})(b.setting_id,b.default_value)}else{f+=fields_ns._generate_option_list_markup(b.setting_id,b.default_value)}f+="</div>";break}f+="</td></tr>"}f+="</table>";if(h){fields_ns.cached_field_settings_markup["field_type_"+p]=f;fields_ns.__check_shared_characteristics_cond2=true;fields_ns.check_shared_characteristics()}}return f};fields_ns._generate_option_list_markup=function(d,j){var f=false;var b="";$.each(fields_ns.option_lists,function(l,m){var k="";if(l==j){k=" selected";f=true}b+='<option value="'+l+'"'+k+">"+m+"</option>"});var i=false;var a="";$.each(fields_ns.forms,function(k,l){if(k==page_ns.form_id){return}a+='<option value="ft'+k+'">'+l+"</option>"});if(b==""&&a==""){return g.messages.phrase_no_option_lists_available+'<div><a href="#" onclick="return fields_ns.create_new_option_list()">'+g.messages.phrase_create_new_option_list+"</a></div>"}var e='<select class="option_list_or_form_field" name="edit_field__setting_'+d+'" id="edit_field__setting_'+d+'"><option value="">'+g.messages.phrase_please_select+"</option>\n";if(b){e+='<optgroup id="edit_field__option_lists" label="'+g.messages.phrase_available_option_lists+'">'+b+"</optgroup>"}if(a){e+='<optgroup id="edit_field__forms" label="'+g.messages.phrase_form_field_contents+'">'+a+"</optgroup>"}var c=(f)?"":' style="display:none"';e+='</select><div id="edit_field__option_list_options"'+c+'><a href="#" onclick="return fields_ns.edit_option_list('+d+')">'+g.messages.phrase_edit_option_list+'</a> | <a href="#" onclick="return fields_ns.create_new_option_list()">'+g.messages.phrase_create_new_option_list+"</a></div>";var h=(i)?"":' style="display:none"';e+='<div id="edit_field__form_options"></div>';return e};fields_ns.edit_option_list=function(c){var b=$("#edit_field__setting_"+c).val();if(!b){$("#edit_field_template_message").removeClass("hidden");ft.display_message("edit_field_template_message",0,g.messages.notify_edit_option_list_after_save);return false}var a=g.root_url+"/admin/forms/option_lists/edit.php?page=main&list_id="+b;if(fields_ns.memory.changed_field_ids.length==0){window.location=a}else{$("#edit_field_template").closest(".ui-dialog").hide();ft.create_dialog({dialog:fields_ns.confirm_redirect_dialog,popup_type:"warning",content:g.messages.confirm_save_change_before_redirect,title:g.messages.phrase_please_confirm,buttons:[{text:g.messages.word_yes,click:function(){$.ajax({url:g.root_url+"/global/code/actions.php",data:{form_id:page_ns.form_id,action:"update_form_fields",data:fields_ns.memory,return_vars:{url:a}},type:"POST",dataType:"json",success:function(d){if(d.success==1){window.location=d.url}},error:function(e,d,f){ft.dialog_activity_icon($("#confirm_before_redirect_dialog"),"hide");$("#confirm_before_redirect_dialog").dialog("close");$("#edit_field_template").dialog("close");ft.error_handler(e,d,f)}});ft.dialog_activity_icon($("#confirm_before_redirect_dialog"),"show")}},{text:g.messages.word_no,click:function(){ft.dialog_activity_icon($("#confirm_before_redirect_dialog"),"show");window.location=a}},{text:g.messages.word_cancel,click:function(){$(this).dialog("close");$("#edit_field_template").closest(".ui-dialog").show()}}]})}return false};fields_ns.create_new_option_list=function(){window.location="./option_lists/index.php?add_option_list=1&field_id="+fields_ns.__current_field_id;return false};fields_ns.load_field_settings_response=function(c){if(!ft.check_ajax_response_permissions(c)){return}fields_ns.cached_loaded_extended_field["field_id_"+c.field_id]={loaded:true,field_type_id:c.field_type_id,settings:c.settings,validation:c.validation};if(c.field_id==fields_ns.__current_field_id){fields_ns.display_field_settings(c.field_type_id,c.settings,c.validation)}var a=false;for(var b in fields_ns.cached_loaded_extended_field){if(fields_ns.cached_loaded_extended_field[b].loading===false){a=true;break}}if(!a){ft.dialog_activity_icon($("#edit_field_template"),"hide")}};fields_ns.display_field_settings=function(a,v,p){var m=false;if(typeof fields_ns.memory["field_"+fields_ns.__current_field_id]!="undefined"){if(typeof fields_ns.memory["field_"+fields_ns.__current_field_id].tab2!="undefined"&&fields_ns.memory["field_"+fields_ns.__current_field_id].tab2!=null){var r=fields_ns.memory["field_"+fields_ns.__current_field_id].tab2;var q=[];for(var u=0;u<v.length;u++){var x=v[u].setting_id;var z=v[u];for(var t=0;t<r.length;t++){var y="edit_field__setting_"+x;if(r[t].name==y){z.setting_value=r[t].value;z.uses_default=false}}q.push(z)}v=q}if(typeof fields_ns.memory["field_"+fields_ns.__current_field_id].tab3!="undefined"){m=true}}for(var u=0,t=v.length;u<t;u++){var x=v[u].setting_id;$("#edit_field__use_default_value_"+x).attr("disabled","");$("#edit_field__use_default_value_"+x).attr("checked",(v[u].uses_default)?"checked":"");var b={};var h=page_ns.field_settings["field_type_"+a];for(var s=0;s<h.length;s++){if(h[s].setting_id==x){b=h[s];break}}switch(b.field_type){case"textbox":case"textarea":case"select":$("#edit_field__setting_"+x).val(v[u].setting_value);if(!v[u].uses_default){$("#edit_field__setting_"+x).removeClass("light_grey").attr("disabled","")}break;case"radios":var c=$("input[name=edit_field__setting_"+x+"]");c.filter("[value="+v[u].setting_value+"]").attr("checked","checked");if(!v[u].uses_default){c.removeClass("light_grey").attr("disabled","")}break;case"option_list_or_form_field":var w=v[u].setting_value.toString().match(/^form_field/);if(w){(function(j,i){ft.queue.push([function(){},function(){var A=(fields_ns.option_lists!=null);var D=(fields_ns.forms!=null);if(A&&D){var C=i.replace(/form_field:/,"").split("|");var k=C[0];var B=C[1];var E=C[2];$("#edit_field__setting_"+j).val("ft"+C[0]);if(fields_ns.form_fields["form_"+k]==undefined){fields_ns.load_form_fields({form_id:k,field_id:B,field_order:E})}else{fields_ns.generate_form_fields_section({form_id:k,field_id:B,field_order:E})}}return(A&&D)}]);ft.process_queue()})(x,v[u].setting_value)}else{if(fields_ns.option_lists==null){}else{$("#edit_field__setting_"+x).val(v[u].setting_value);$("#edit_field__option_list_options").show();$("#edit_field__form_options").hide();fields_ns.onload_field_setting_values.push({setting_id:x,setting_value:v[u].setting_value})}}break;default:break}}var o=fields_ns.generate_field_type_validation_table(a);$("#validation_table").html(o);var d=0;if(m){var l=fields_ns.memory["field_"+fields_ns.__current_field_id].tab3;for(var u=0;u<l.length;u++){var e=l[u].name.match(/^edit_field__v_(.*)_message$/);if(e){var f=e[1];$("#edit_field__v_"+f).attr("checked","checked");$("#edit_field__v_"+f+"_message").removeClass("light_grey").attr("disabled","").val(l[u].value)}}}else{for(var u=0;u<p.length;u++){var f=p[u].rule_id;var n=p[u].error_message.replace(/\\/g,"");$("#edit_field__v_"+f).attr("checked","checked");$("#edit_field__v_"+f+"_message").removeClass("light_grey").attr("disabled","").val(n)}}fields_ns.update_validation_tab_label(a);$("#edit_field__field_settings_loading").hide();$("#edit_field__field_settings").show()};fields_ns.update_validation_tab_label=function(b){var a=0;if(typeof page_ns.field_validation["field_type_"+b]!="undefined"){a=page_ns.field_validation["field_type_"+b].length}if(fields_ns.__current_field_is_system_field){a=0}$("#edit_field_template .inner_tab3").html(g.messages.word_validation+" ("+a+")")};fields_ns.edit_prev_field=function(){if($("#edit_field_template .prev_field").hasClass("disabled")){return false}if(!fields_ns.validate_field()){return false}var a=sortable_ns._get_previous_row_group(fields_ns.__current_editing_row_group);fields_ns.edit_field(a)};fields_ns.edit_next_field=function(){if($("#edit_field_template .next_field").hasClass("disabled")){return false}if(!fields_ns.validate_field()){return false}var a=sortable_ns._get_next_row_group(fields_ns.__current_editing_row_group);fields_ns.edit_field(a)};fields_ns.save_changes=function(){if(fields_ns.memory.changed_field_ids.length==0){$("#edit_field_template").dialog("close");ft.display_message("ft_message",1,g.messages.notify_field_changes_saved);return}if(!fields_ns.validate_field()){return false}$.ajax({url:g.root_url+"/global/code/actions.php",data:{form_id:page_ns.form_id,action:"update_form_fields",data:fields_ns.memory},type:"POST",dataType:"json",success:fields_ns.save_changes_response,error:function(b,a,c){ft.dialog_activity_icon($("#edit_field_template"),"hide");$("#edit_field_template").dialog("close");ft.error_handler(b,a,c)}});ft.dialog_activity_icon($("#edit_field_template"),"show")};fields_ns.save_changes_response=function(c){if(!ft.check_ajax_response_permissions(c)){return}if(c.success==1){for(var a=0;a<fields_ns.memory.changed_field_ids.length;a++){var b=fields_ns.memory.changed_field_ids[a];if(typeof fields_ns.memory["field_"+b].tab1!="undefined"&&fields_ns.memory["field_"+b].tab1!=null){$("#field_"+b+"_include_on_redirect").attr("checked","");$.each(fields_ns.memory["field_"+b].tab1,function(d,e){switch(e.name){case"edit_field__display_text":$("#field_"+b+"_display_name").val(e.value);break;case"edit_field__field_name":$("#field_"+b+"_name").val(e.value);break;case"edit_field__field_type":$("#field_"+b+"_type_id").val(e.value);$("#old_field_"+b+"_type_id").val(e.value);break;case"edit_field__pass_on":$("#field_"+b+"_include_on_redirect").attr("checked","checked");break;case"edit_field__field_size":$("#old_field_"+b+"_size").val(e.value);$("#field_"+b+"_size").val(e.value);break;case"edit_field__data_type":$("#field_"+b+"_data_type").val(e.value);break;case"edit_field__db_column":$("#old_col_"+b+"_name").val(e.value);$("#col_"+b+"_name").val(e.value);break}})}}ft.dialog_activity_icon($("#edit_field_template"),"hide");$("#edit_field_template").dialog("close");ft.display_message("ft_message",1,g.messages.notify_field_changes_saved);fields_ns.memory={};fields_ns.memory.changed_field_ids=[];fields_ns.cached_loaded_extended_field=[]}else{ft.display_message("ft_message",0,g.messages.notify_error_saving_fields)}};fields_ns.validate_field=function(){var j=[];var c=1;var f=$(".sr_order[value="+fields_ns.__current_field_id+"]").closest(".row_group").hasClass("system_field");var h=$.trim($("#edit_field__display_text").val());if(h==""){j.push(["#edit_field__display_text","validation_no_display_text_single"])}if(!f){var a=$.trim($("#edit_field__field_name").val());if(a==""){j.push(["#edit_field__field_name","validation_no_form_field_single"])}var b=$.trim($("#edit_field__db_column").val());if(b==""){j.push(["#edit_field__db_column","validation_no_db_column_single"])}}if(j.length>0){$("#edit_field_template_message").removeClass("hidden");ft.change_inner_tab(c,"edit_field");$(j[0][0]).focus();var e="";if(j.length==1){e=g.messages[j[0][1]]}else{for(var d=0;d<j.length;d++){e+="&bull; "+g.messages[j[d][1]]+"<br />"}}ft.display_message("edit_field_template_message",0,e)}return j.length==0};fields_ns.load_form_fields=function(a){var a=$.extend({form_id:null,field_id:null,field_order:null},a);a.form_id=a.form_id.replace(/^ft/,"");$("#edit_field__form_options").html('<div class="loading_small"></div>');$.ajax({url:g.root_url+"/global/code/actions.php",type:"POST",dataType:"json",data:{action:"get_form_fields",form_id:a.form_id,field_id:a.field_id,field_order:a.field_order},success:fields_ns.get_form_fields_response,error:ft.error_handler})};fields_ns.get_form_fields_response=function(a){if(!ft.check_ajax_response_permissions(a)){return}fields_ns.form_fields["form_"+a.form_id]=a.fields;if($(".option_list_or_form_field :selected").val()=="ft"+a.form_id.toString()){fields_ns.generate_form_fields_section({form_id:a.form_id,field_id:a.field_id,field_order:a.field_order})}};fields_ns.generate_form_fields_section=function(d){d=$.extend({form_id:null,field_id:"",field_order:""},d);var a=fields_ns.form_fields["form_"+d.form_id];var e=null;$("#edit_field__form_options").parent().find(".option_list_or_form_field").each(function(){e=$(this).attr("id").replace(/edit_field__setting_/,"")});var c='<select name="edit_field__setting_'+e+'_field_id"><option value="">'+g.messages.phrase_please_select+"</option>";$.each(a,function(h,i){var f=(h.toString()==d.field_id.toString())?" selected":"";c+='<option value="'+h+'"'+f+">"+i+"</option>"});c+="</select>";var b='<table class="grey_box"><tr><td width="100">'+g.messages.phrase_select_field+"</td><td>"+c+"</td></tr><tr><td>"+g.messages.word_order+'</td><td><select name="edit_field__setting_'+e+'_field_order"><option value="ASC"'+((d.field_order=="ASC")?" selected":"")+'>ASC</option><option value="DESC"'+((d.field_order=="DESC")?" selected":"")+">DESC</option></select></td></tr>";$("#edit_field__form_options").html(b)};fields_ns.click_use_default=function(c){var a=$(c).attr("checked");var d=$(c).attr("id").replace(/^edit_field__use_default_value_/,"");var b="#edit_field__setting_"+d+',[id^="edit_field__setting_'+d+'_"]';if(a){$(b).attr("disabled","disabled").addClass("light_grey")}else{$(b).attr("disabled","").removeClass("light_grey");$("#edit_field__setting_"+d).focus()}$(c).trigger("change")};fields_ns.check_shared_characteristics=function(){var h=fields_ns.__current_field_type_id;var l=fields_ns.__last_field_type_id;if(h==l){return}if(!fields_ns.__check_shared_characteristics_cond1||!fields_ns.__check_shared_characteristics_cond2){return}if(typeof page_ns.field_settings["field_type_"+h]=="undefined"||typeof page_ns.field_settings["field_type_"+l]=="undefined"){return}var s=[];for(var f=0;f<page_ns.field_settings["field_type_"+h].length;f++){var o=page_ns.field_settings["field_type_"+h][f].setting_id;if(page_ns.shared_characteristics["s"+o]!=undefined){s.push(o)}}var c=[];for(var f=0;f<page_ns.field_settings["field_type_"+l].length;f++){var p=page_ns.field_settings["field_type_"+l][f].setting_id;if(page_ns.shared_characteristics["s"+p]!=undefined){c.push(p)}}if(!s.length||!c.length){return}var b=[];for(var f=0;f<c.length;f++){var m=page_ns.shared_characteristics["s"+c[f]];for(var e=0;e<s.length;e++){var q=page_ns.shared_characteristics["s"+s[e]];for(var d=0;d<q.length;d++){if($.inArray(q[d],m)!=-1){b.push([c[f],s[e]])}}}}var n=fields_ns.memory["field_"+fields_ns.__current_field_id].tab2;for(var f=0;f<b.length;f++){var a=b[f][0];var r=b[f][1];for(var e=0;e<n.length;e++){if(n[e].name==undefined||n[e].value==undefined){continue}if(n[e].name!="edit_field__setting_"+a){continue}$("#edit_field__use_default_value_"+r).attr("checked","");$("#edit_field__setting_"+r).val(n[e].value).removeClass("light_grey").attr("disabled","")}}fields_ns.__check_shared_characteristics_cond1=false;fields_ns.__check_shared_characteristics_cond2=false};fields_ns.generate_field_type_validation_table=function(e){var c="";if(typeof page_ns.field_validation["field_type_"+e]=="undefined"){c='<span class="medium_grey"><i>'+g.messages.phrase_field_type_no_validation+"</span>"}else{c+='<table cellspacing="0" cellpadding="0" width="100%"><tr><td width="20"></td><td width="180" class="medium_grey"><i>'+g.messages.phrase_validation_rule+'</i></td><td class="medium_grey"><i>'+g.messages.text_error_message_to_show+"</i></td></tr>";var f=page_ns.field_validation["field_type_"+e];for(var b=0;b<f.length;b++){var d=f[b].rule_id;var a=f[b].label;c+='<tr><td><input type="checkbox" name="edit_field__v_'+d+'" id="edit_field__v_'+d+'" class="v_checked" /></td><td><label for="edit_field__v_'+d+'">'+a+'</label></td><td><input type="text" id="edit_field__v_'+d+'_message" name="edit_field__v_'+d+'_message" class="validation_error_message light_grey" disabled="disabled" /></td></tr>'}c+="</table>"}return c};fields_ns._get_default_error_message=function(d,c){var a="";var e=page_ns.field_validation["field_type_"+d];for(var b=0;b<e.length;b++){if(e[b].rule_id==c){a=e[b].error;break}}return a};